version: "1"

services:
  - type: web
    name: ruby-wings-chatbot-v4
    env: python
    plan: starter
    region: singapore
    autoDeploy: true
    branch: main

    healthCheckPath: /api/health
    healthCheckTimeout: 30
    initialDelaySec: 60

    buildCommand: |
      echo "ðŸš€ Ruby Wings build started"
      
      python -m pip install --upgrade pip setuptools wheel
      
      echo "ðŸ“¦ Installing dependencies"
      pip install -r requirements.txt

      
      echo "ðŸ“ Prepare folders"
      mkdir -p data logs
      
      if [ ! -f "knowledge.json" ]; then
        echo '{"tours": []}' > knowledge.json
      fi
      
      # Build embeddings ONLY if FAISS is enabled
      if [ "$FAISS_ENABLED" = "true" ]; then
        echo "ðŸ§  FAISS enabled â€“ building index"
        python build_index.py
      else
        echo "ðŸ§  FAISS disabled â€“ using numpy fallback only"
      fi
      
      echo "âœ… Build done"

    startCommand: |
      echo "ðŸš€ Ruby Wings starting"

      export RAM_PROFILE=${RAM_PROFILE:-512}

      if [ "$RAM_PROFILE" = "2048" ]; then
        echo "ðŸš€ High-RAM mode (2GB)"
        export GUNICORN_WORKERS=${GUNICORN_WORKERS:-2}
        export GUNICORN_THREADS=${GUNICORN_THREADS:-4}
        export FAISS_ENABLED=true
      else
        echo "ðŸ§  Low-RAM mode (512MB)"
        export GUNICORN_WORKERS=${GUNICORN_WORKERS:-1}
        export GUNICORN_THREADS=${GUNICORN_THREADS:-2}
        export FAISS_ENABLED=false
      fi

      gunicorn app:app \
        --workers $GUNICORN_WORKERS \
        --threads $GUNICORN_THREADS \
        --bind=0.0.0.0:$PORT \
        --timeout ${TIMEOUT:-120} \
        --graceful-timeout ${GUNICORN_GRACEFUL_TIMEOUT:-30} \
        --keepalive ${GUNICORN_KEEPALIVE:-5} \
        --max-requests ${GUNICORN_MAX_REQUESTS:-1000} \
        --max-requests-jitter ${GUNICORN_MAX_REQUESTS_JITTER:-50} \
        --worker-connections ${GUNICORN_WORKER_CONNECTIONS:-1000} \
        --log-level ${GUNICORN_LOG_LEVEL:-info} \
        --access-logfile - \
        --error-logfile -

    disk:
      name: ruby-wings-data
      mountPath: /opt/render/project/src/data
      sizeGB: 1

    envVars:
      # ===== RAM MODE =====
      - key: RAM_PROFILE
        value: "512"

      # ===== AI =====
      - key: OPENAI_API_KEY
        sync: false
        required: true

      - key: EMBEDDING_MODEL
        value: "text-embedding-3-small"

      - key: CHAT_MODEL
        value: "gpt-4o-mini"

      # ===== INDEX =====
      - key: KNOWLEDGE_PATH
        value: "knowledge.json"

      - key: FAISS_ENABLED
        value: "false"

      - key: FAISS_INDEX_PATH
        value: "data/faiss_index.bin"

      - key: FAISS_MAPPING_PATH
        value: "data/faiss_mapping.json"

      - key: FALLBACK_VECTORS_PATH
        value: "data/vectors.npz"

      # ===== GOOGLE =====
      - key: ENABLE_GOOGLE_SHEETS
        value: "true"

      - key: GOOGLE_SERVICE_ACCOUNT_JSON
        sync: false
        required: true

      - key: GOOGLE_SHEET_ID
        value: "1SdVbwkuxb8l1meEW--ddyfh4WmUvSXXMOPQ5bCyPkdk"

      - key: GOOGLE_SHEET_NAME
        value: "RBW_Lead_Raw_Inbox"

      # ===== META =====
      - key: ENABLE_META_CAPI_CALL
        value: "true"

      - key: META_CAPI_TOKEN
        sync: false

      - key: META_PIXEL_ID
        value: "862531473384426"

      # ===== SERVER =====
      - key: PORT
        value: "10000"

      - key: FLASK_ENV
        value: "production"

      - key: DEBUG
        value: "false"

      - key: SECRET_KEY
        sync: false
        generateValue: true

      # ===== UPGRADES =====
      - key: UPGRADE_1_MANDATORY_FILTER
        value: "true"
      - key: UPGRADE_2_DEDUPLICATION
        value: "true"
      - key: UPGRADE_3_ENHANCED_FIELDS
        value: "true"
      - key: UPGRADE_4_QUESTION_PIPELINE
        value: "true"
      - key: UPGRADE_5_QUERY_SPLITTER
        value: "true"
      - key: UPGRADE_6_FUZZY_MATCHING
        value: "true"
      - key: UPGRADE_7_STATE_MACHINE
        value: "true"
      - key: UPGRADE_8_SEMANTIC_ANALYSIS
        value: "true"
      - key: UPGRADE_9_AUTO_VALIDATION
        value: "true"
      - key: UPGRADE_10_TEMPLATE_SYSTEM
        value: "true"

    resources:
      cpu: 1
      memoryMB: 512

    scaling:
      minInstances: 1
      maxInstances: 2
      targetMemoryPercent: 75
      targetCPUPercent: 70
