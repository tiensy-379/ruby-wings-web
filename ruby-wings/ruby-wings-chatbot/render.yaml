services:
  - type: web
    name: ruby-wings-chatbot
    env: python
    plan: free

    buildCommand: "pip install --no-cache-dir -r requirements.txt"
    startCommand: "gunicorn app:app --bind 0.0.0.0:$PORT --workers 1 --threads 4 --timeout 300"

    envVars:
      # ===== CORE CONFIGURATION =====
      - key: OPENAI_API_KEY
        sync: false  # Đặt trong Render Dashboard

      - key: OPENAI_BASE_URL
        value: "https://api.openai.com/v1"

      - key: FLASK_ENV
        value: "production"

      - key: PORT
        value: "10000"

      # ===== FAISS & CHATBOT CONFIG =====
      - key: FAISS_ENABLED
        value: "true"

      - key: RBW_ALLOW_REINDEX
        value: "0"

      - key: KNOWLEDGE_PATH
        value: "knowledge.json"

      - key: FALLBACK_VECTORS_PATH
        value: "vectors.npz"

      - key: FAISS_MAPPING_PATH
        value: "faiss_mapping.json"

      - key: FAISS_INDEX_PATH
        value: "faiss_index.bin"

      # ===== AI MODELS =====
      - key: EMBEDDING_MODEL
        value: "text-embedding-3-small"

      - key: CHAT_MODEL
        value: "gpt-4o-mini"

      - key: TOP_K
        value: "5"

      # ===== GOOGLE SHEETS INTEGRATION =====
      - key: ENABLE_GOOGLE_SHEETS
        value: "true"

      - key: GOOGLE_SERVICE_ACCOUNT_JSON
        sync: false  # Đặt trong Render Dashboard với JSON đầy đủ

      - key: GOOGLE_SHEET_ID
        value: "1SdVbwkuxb8l1meEW--ddyfh4WmUvSXXMOPQ5bCyPkdk"

      - key: GOOGLE_SHEET_NAME
        value: "RBW_Lead_Raw_Inbox"

      # ===== FALLBACK STORAGE =====
      - key: ENABLE_FALLBACK_STORAGE
        value: "true"

      - key: FALLBACK_STORAGE_PATH
        value: "leads_fallback.json"

      # ===== PERFORMANCE =====
      - key: WORKERS
        value: "1"

      - key: TIMEOUT
        value: "300"

      - key: DEBUG
        value: "false"

      - key: LOG_LEVEL
        value: "INFO"

      # ===== META CONVERSION API (CAPI) =====
      - key: META_PIXEL_ID
        value: "862531473384426"

      - key: META_CAPI_TOKEN
        sync: false  # Đặt trong Render Dashboard

      - key: META_TEST_EVENT_CODE
        value: ""  # TEST12345 khi cần test, để trống khi production

      # ===== META CAPI FEATURE FLAGS =====
      - key: ENABLE_META_CAPI_LEAD
        value: "true"  # Bật tracking lead qua /api/save-lead

      - key: ENABLE_META_CAPI_CALL
        value: "true"  # Bật tracking cho nút gọi điện (FIXED VERSION)

      - key: DEBUG_META_CAPI
        value: "true"  # Bật log debug cho Meta CAPI

      # ===== SECURITY =====
      - key: SECRET_KEY
        generateValue: true

      - key: CORS_ORIGINS
        value: "https://www.rubywings.vn,https://rubywings.vn"

      # ===== SYSTEM =====
      - key: HOST
        value: "0.0.0.0"

      - key: MAX_CONTENT_LENGTH
        value: "16777216"  # 16MB

    healthCheckPath: "/api/health"
    healthCheckTimeout: 30

    autoDeploy: true
    branch: main

    disk:
      name: chatbot-storage
      mountPath: /data
      sizeGB: 1

    # Build cache optimization
    buildFilter:
      paths:
        - "*.py"
        - "requirements.txt"
        - "knowledge.json"
        - "*.json"
        - "render.yaml"
      ignoredPaths:
        - "__pycache__/"
        - "*.pyc"
        - ".git/"
        - "logs/"
        - "*.log"

    # Advanced configuration for better performance
    scaling:
      minInstances: 1
      maxInstances: 1

    # Header configuration for security
    headers:
      - path: /*
        name: X-Content-Type-Options
        value: nosniff
      - path: /*
        name: X-Frame-Options
        value: DENY
      - path: /*
        name: X-XSS-Protection
        value: 1; mode=block

    # CORS configuration
    cors:
      allowedOrigins:
        - "https://www.rubywings.vn"
        - "https://rubywings.vn"
      allowedMethods:
        - GET
        - POST
        - OPTIONS
      allowedHeaders:
        - Content-Type
        - Authorization
        - X-Requested-With
      allowCredentials: true
      maxAge: 86400
      startCommand: "gunicorn app:app --bind 0.0.0.0:$PORT --workers $GUNICORN_WORKERS --threads $GUNICORN_THREADS --timeout $TIMEOUT --worker-class=gthread --worker-tmp-dir=/dev/shm"