version: "1"

services:
  - type: web
    name: ruby-wings-chatbot-v5
    env: docker  # QUAN TR·ªåNG: ƒê·ªïi t·ª´ python sang docker
    plan: starter
    region: singapore
    autoDeploy: true
    branch: main
    dockerfilePath: ./Dockerfile  # Ch·ªâ ƒë·ªãnh ƒë∆∞·ªùng d·∫´n Dockerfile

    healthCheckPath: /health
    healthCheckTimeout: 30
    initialDelaySec: 60

    buildCommand: |
      echo "üöÄ Ruby Wings v5.2 Docker build started"
      echo "üì¶ Building Docker image..."
      # Build command s·∫Ω ƒë∆∞·ª£c th·ª±c hi·ªán b·ªüi Docker, kh√¥ng c·∫ßn buildCommand chi ti·∫øt
      # Render s·∫Ω t·ª± ƒë·ªông ch·∫°y: docker build -t ruby-wings .
      
    startCommand: |
      echo "üöÄ Ruby Wings v5.2 starting..."
      echo "üìä System Configuration:"
      echo "  - RAM Profile: $RAM_PROFILE"
      echo "  - OpenAI: $([ -n "$OPENAI_API_KEY" ] && echo "Available" || echo "Not Available")"
      echo "  - FAISS: $([ "$FAISS_ENABLED" = "true" ] && echo "Enabled" || echo "Disabled")"
      echo "  - State Machine: $([ "$STATE_MACHINE_ENABLED" = "true" ] && echo "Enabled" || echo "Disabled")"
      
      # Ch·∫°y ·ª©ng d·ª•ng t·ª´ Docker container
      # Container ƒë√£ ƒë∆∞·ª£c build v·ªõi CMD trong Dockerfile
      # Kh√¥ng c·∫ßn startCommand ph·ª©c t·∫°p, Docker s·∫Ω t·ª± ƒë·ªông ch·∫°y CMD

    disk:
      name: ruby-wings-data-v5
      mountPath: /app/data
      sizeGB: 1

    envVars:
      # ===== APP VERSION =====
      - key: APP_VERSION
        value: "5.2"
      
      # ===== RAM OPTIMIZATION =====
      - key: RAM_PROFILE
        value: "512"

      # ===== FEATURE TOGGLES (v5.2) =====
      - key: ENABLE_INTENT_DETECTION
        value: "true"
      - key: ENABLE_PHONE_DETECTION
        value: "true"
      - key: ENABLE_LEAD_CAPTURE
        value: "true"
      - key: ENABLE_LLM_FALLBACK
        value: "true"
      - key: ENABLE_CACHING
        value: "true"
      - key: ENABLE_GOOGLE_SHEETS
        value: "true"
      - key: ENABLE_META_CAPI
        value: "false"
      - key: FAISS_ENABLED
        value: "false"

      # ===== STATE MACHINE (v5.2 NEW) =====
      - key: STATE_MACHINE_ENABLED
        value: "true"
      - key: CONVERSATION_HISTORY_LIMIT
        value: "10"
      - key: AUTO_STAGE_TRANSITION
        value: "true"

      # ===== RESPONSE FORMATTING (v5.2 NEW) =====
      - key: MAX_TOURS_PER_RESPONSE
        value: "3"
      - key: ENABLE_TOUR_LABELS
        value: "true"
      - key: ENABLE_LOCATION_CONTEXT
        value: "true"
      - key: LOCATION_FILTER_STRICT
        value: "true"
      - key: ENABLE_REGION_FALLBACK
        value: "true"

      # ===== INTENT DETECTION (v5.2 NEW) =====
      - key: INTENT_CONFIDENCE_THRESHOLD
        value: "0.6"
      - key: ENABLE_FUZZY_MATCHING
        value: "true"
      - key: ENABLE_PHONE_VALIDATION
        value: "true"

      # ===== PERFORMANCE TUNING =====
      - key: MAX_SESSIONS
        value: "100"
      - key: MAX_EMBEDDING_CACHE
        value: "50"
      - key: CACHE_TTL_SECONDS
        value: "300"

      # ===== OPENAI CONFIGURATION =====
      - key: OPENAI_API_KEY
        sync: false
        required: true
      - key: OPENAI_EMBEDDING_MODEL
        value: "text-embedding-3-small"
      - key: OPENAI_CHAT_MODEL
        value: "gpt-4o-mini"

      # ===== FILE PATHS =====
      - key: KNOWLEDGE_PATH
        value: "/app/data/knowledge.json"
      - key: FAISS_INDEX_PATH
        value: "/app/data/faiss_index.bin"
      - key: FAISS_MAPPING_PATH
        value: "/app/data/faiss_mapping.json"
      - key: FALLBACK_VECTORS_PATH
        value: "/app/data/vectors.npz"
      - key: TOUR_ENTITIES_PATH
        value: "/app/data/tour_entities.json"

      # ===== GOOGLE SHEETS =====
      - key: GOOGLE_SERVICE_ACCOUNT_JSON
        sync: false
      - key: GOOGLE_SHEET_ID
        value: "1SdVbwkuxb8l1meEW--ddyfh4WmUvSXXMOPQ5bCyPkdk"
      - key: GOOGLE_SHEET_NAME
        value: "RBW_Lead_Raw_Inbox"

      # ===== META CAPI =====
      - key: META_CAPI_TOKEN
        sync: false
      - key: META_PIXEL_ID
        value: "862531473384426"

      # ===== SERVER CONFIGURATION =====
      - key: PORT
        value: "10000"
      - key: HOST
        value: "0.0.0.0"
      - key: FLASK_ENV
        value: "production"
      - key: SECRET_KEY
        sync: false
        generateValue: true
      - key: ADMIN_SECRET
        sync: false
        generateValue: true

      # ===== SESSION CONFIGURATION =====
      - key: SESSION_TYPE
        value: "filesystem"
      - key: SESSION_PERMANENT
        value: "false"
      - key: SESSION_USE_SIGNER
        value: "true"
      - key: SESSION_KEY_PREFIX
        value: "ruby_wings_v5_"

      # ===== CORS =====
      - key: CORS_ORIGINS
        value: "*"

    resources:
      cpu: 1
      memoryMB: 512

    scaling:
      minInstances: 1
      maxInstances: 2
      targetMemoryPercent: 75
      targetCPUPercent: 70